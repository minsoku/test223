<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quest ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì • ë„êµ¬</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: white;
      }
      .container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        backdrop-filter: blur(10px);
      }
      h1 {
        text-align: center;
        color: #4ecdc4;
      }
      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }
      .success {
        background: #4caf50;
      }
      .error {
        background: #f44336;
      }
      .warning {
        background: #ff9800;
      }
      .info {
        background: #2196f3;
      }
      button {
        background: #4ecdc4;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }
      button:hover {
        background: #45b7b8;
      }
      button:disabled {
        background: #666;
        cursor: not-allowed;
      }
      #log {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: 20px;
      }
      .fix-section {
        background: rgba(255, 255, 255, 0.05);
        padding: 20px;
        margin: 20px 0;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .controller-status {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 20px 0;
      }
      .controller-card {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 10px;
        border: 2px solid #666;
      }
      .controller-card.active {
        border-color: #4caf50;
      }
      .button-test {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      .btn-indicator {
        background: rgba(255, 255, 255, 0.1);
        padding: 5px;
        border-radius: 5px;
        text-align: center;
        font-size: 12px;
      }
      .btn-indicator.pressed {
        background: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ Quest ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì • ë„êµ¬</h1>

      <div class="fix-section">
        <h3>ğŸ“‹ ì§„ë‹¨ ê²°ê³¼</h3>
        <div id="diagnosis">ì§„ë‹¨ì„ ì‹œì‘í•˜ì„¸ìš”...</div>
      </div>

      <button onclick="runDiagnosis()">ğŸ” ì „ì²´ ì§„ë‹¨ ì‹¤í–‰</button>
      <button onclick="testPermissions()">ğŸ” ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
      <button onclick="testAlternativeMethod()">ğŸ”„ ëŒ€ì²´ ë°©ë²• í…ŒìŠ¤íŠ¸</button>
      <button onclick="clearLog()">ğŸ—‘ï¸ ë¡œê·¸ ì§€ìš°ê¸°</button>

      <div class="controller-status">
        <div id="left-controller" class="controller-card">
          <h4>ğŸ‘ˆ ì™¼ìª½ ì»¨íŠ¸ë¡¤ëŸ¬</h4>
          <div id="left-info">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
          <div class="button-test">
            <div id="left-0" class="btn-indicator">íŠ¸ë¦¬ê±°</div>
            <div id="left-1" class="btn-indicator">ê·¸ë¦½</div>
            <div id="left-2" class="btn-indicator">ë©”ë‰´</div>
            <div id="left-3" class="btn-indicator">ìŠ¤í‹±</div>
            <div id="left-4" class="btn-indicator">X</div>
            <div id="left-5" class="btn-indicator">Y</div>
          </div>
        </div>
        <div id="right-controller" class="controller-card">
          <h4>ğŸ‘‰ ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ëŸ¬</h4>
          <div id="right-info">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
          <div class="button-test">
            <div id="right-0" class="btn-indicator">íŠ¸ë¦¬ê±°</div>
            <div id="right-1" class="btn-indicator">ê·¸ë¦½</div>
            <div id="right-2" class="btn-indicator">ì˜¤í˜ëŸ¬ìŠ¤</div>
            <div id="right-3" class="btn-indicator">ìŠ¤í‹±</div>
            <div id="right-4" class="btn-indicator">A</div>
            <div id="right-5" class="btn-indicator">B</div>
          </div>
        </div>
      </div>

      <div class="fix-section">
        <h3>ğŸ’¡ ìˆ˜ì • ê°€ì´ë“œ</h3>
        <div class="status info">
          <strong>Quest ë¸Œë¼ìš°ì €ì—ì„œ ì»¨íŠ¸ë¡¤ëŸ¬ ì…ë ¥ì´ 0ìœ¼ë¡œ ë‚˜ì˜¤ëŠ” ê²½ìš°:</strong
          ><br /><br />
          <strong>1ë‹¨ê³„ - Quest ì„¤ì •:</strong><br />
          â€¢ ì„¤ì • â†’ ì‹œìŠ¤í…œ â†’ ê°œë°œì â†’ "USB ì—°ê²° ëŒ€í™”ìƒì" í™œì„±í™”<br />
          â€¢ ì„¤ì • â†’ ê°œì¸ì •ë³´ ë³´í˜¸ â†’ "ì† ì¶”ì  ë°ì´í„° ì•¡ì„¸ìŠ¤" í—ˆìš©<br /><br />
          <strong>2ë‹¨ê³„ - ë¸Œë¼ìš°ì € ê¶Œí•œ:</strong><br />
          â€¢ ì£¼ì†Œì°½ì— chrome://settings/content/sensors ì…ë ¥<br />
          â€¢ ëª¨ì…˜ ì„¼ì„œ ë° ê¸°ê¸° ë°©í–¥ í—ˆìš©<br /><br />
          <strong>3ë‹¨ê³„ - ì»¨íŠ¸ë¡¤ëŸ¬ ì¬ì„¤ì •:</strong><br />
          â€¢ ì˜¤í˜ëŸ¬ìŠ¤ ë²„íŠ¼ + ë©”ë‰´ ë²„íŠ¼ 15ì´ˆê°„ ê¸¸ê²Œ ëˆ„ë¥´ê¸°<br />
          â€¢ Quest ì¬ì‹œì‘ í›„ ì»¨íŠ¸ë¡¤ëŸ¬ ì¬í˜ì–´ë§
        </div>
      </div>

      <div id="log"></div>
    </div>

    <script>
      let session = null;
      let isTracking = false;
      let lastInputTime = 0;

      function log(message, color = "#ffffff") {
        const logElement = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
        logElement.innerHTML += logEntry;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
      }

      function updateDiagnosis(message, type = "info") {
        const diagnosisElement = document.getElementById("diagnosis");
        diagnosisElement.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      async function runDiagnosis() {
        log("ğŸ” ì „ì²´ ì§„ë‹¨ì„ ì‹œì‘í•©ë‹ˆë‹¤...", "#4ecdc4");

        // 1. ê¸°ë³¸ WebXR í™•ì¸
        if (!navigator.xr) {
          updateDiagnosis(
            "âŒ WebXR ë¯¸ì§€ì› - ìµœì‹  Chrome/Edge ì‚¬ìš© í•„ìš”",
            "error"
          );
          log("âŒ navigator.xrì´ ì—†ìŠµë‹ˆë‹¤", "#f44336");
          return;
        }

        log("âœ… WebXR API ì‚¬ìš© ê°€ëŠ¥", "#4caf50");

        // 2. VR ì„¸ì…˜ ì§€ì› í™•ì¸
        try {
          const vrSupported = await navigator.xr.isSessionSupported(
            "immersive-vr"
          );
          if (!vrSupported) {
            updateDiagnosis(
              "âŒ VR ì„¸ì…˜ ë¯¸ì§€ì› - í—¤ë“œì…‹ ì—°ê²° í™•ì¸ í•„ìš”",
              "error"
            );
            log("âŒ VR ì„¸ì…˜ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤", "#f44336");
            return;
          }

          log("âœ… VR ì„¸ì…˜ ì§€ì›ë¨", "#4caf50");

          // 3. ì‹¤ì œ VR ì„¸ì…˜ í…ŒìŠ¤íŠ¸
          await testVRSession();
        } catch (error) {
          updateDiagnosis(`âŒ ì§„ë‹¨ ì‹¤íŒ¨: ${error.message}`, "error");
          log(`âŒ ì§„ë‹¨ ì¤‘ ì˜¤ë¥˜: ${error.message}`, "#f44336");
        }
      }

      async function testVRSession() {
        try {
          log("ğŸš€ VR ì„¸ì…˜ ìƒì„± ì‹œë„...", "#2196f3");

          // ì—¬ëŸ¬ ì˜µì…˜ìœ¼ë¡œ ì‹œë„
          const sessionOptions = [
            { optionalFeatures: ["local-floor", "bounded-floor"] },
            { optionalFeatures: ["local-floor"] },
            {}, // ê¸°ë³¸ ì˜µì…˜
          ];

          for (let i = 0; i < sessionOptions.length; i++) {
            try {
              session = await navigator.xr.requestSession(
                "immersive-vr",
                sessionOptions[i]
              );
              log(`âœ… VR ì„¸ì…˜ ìƒì„± ì„±ê³µ (ì˜µì…˜ ${i + 1})`, "#4caf50");
              break;
            } catch (e) {
              log(`âŒ ì˜µì…˜ ${i + 1} ì‹¤íŒ¨: ${e.message}`, "#ff9800");
              if (i === sessionOptions.length - 1) throw e;
            }
          }

          if (!session) {
            throw new Error("ëª¨ë“  VR ì„¸ì…˜ ì˜µì…˜ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
          }

          // 4. ì»¨íŠ¸ë¡¤ëŸ¬ ê°ì§€ í…ŒìŠ¤íŠ¸
          await testControllerDetection();
        } catch (error) {
          updateDiagnosis(`âŒ VR ì„¸ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, "error");
          log(`âŒ VR ì„¸ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, "#f44336");
        }
      }

      async function testControllerDetection() {
        log("ğŸ® ì»¨íŠ¸ë¡¤ëŸ¬ ê°ì§€ í…ŒìŠ¤íŠ¸ ì‹œì‘...", "#2196f3");

        // ì…ë ¥ ì†ŒìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸ ë“±ë¡
        session.addEventListener("inputsourceschange", (event) => {
          log(
            `ğŸ“¡ ì…ë ¥ ì†ŒìŠ¤ ë³€ê²½ë¨: +${event.added.length}, -${event.removed.length}`,
            "#ff9800"
          );
          checkInputSources();
        });

        // ì„¸ì…˜ ì¢…ë£Œ ì´ë²¤íŠ¸
        session.addEventListener("end", () => {
          log("VR ì„¸ì…˜ ì¢…ë£Œë¨", "#666666");
          isTracking = false;
          resetControllerUI();
        });

        // ì´ˆê¸° ì…ë ¥ ì†ŒìŠ¤ í™•ì¸
        checkInputSources();

        // ì§€ì†ì ì¸ ì…ë ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        startInputMonitoring();

        updateDiagnosis(
          "âœ… ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ - ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!",
          "success"
        );
      }

      function checkInputSources() {
        if (!session) return;

        const inputSources = session.inputSources;
        log(`ğŸ” í˜„ì¬ ì…ë ¥ ì†ŒìŠ¤: ${inputSources.length}ê°œ`, "#2196f3");

        // UI ì´ˆê¸°í™”
        resetControllerUI();

        if (inputSources.length === 0) {
          log("âš ï¸ ì…ë ¥ ì†ŒìŠ¤ê°€ ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤", "#ff9800");
          updateDiagnosis(
            "âš ï¸ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ê°ì§€ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤ - ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ í”ë“¤ì–´ë³´ì„¸ìš”",
            "warning"
          );
          return;
        }

        // ê° ì…ë ¥ ì†ŒìŠ¤ ë¶„ì„
        inputSources.forEach((source, index) => {
          const hand = source.handedness;
          const targetRayMode = source.targetRayMode;
          const hasGamepad = !!source.gamepad;

          log(
            `ğŸ“‹ ì…ë ¥ ì†ŒìŠ¤ ${index}: ì†=${hand}, ëª¨ë“œ=${targetRayMode}, ê²Œì„íŒ¨ë“œ=${hasGamepad}`,
            "#4ecdc4"
          );

          if (hand === "left" || hand === "right") {
            updateControllerUI(hand, "âœ… ì—°ê²°ë¨", true);

            if (hasGamepad) {
              log(`ğŸ® ${hand} ì»¨íŠ¸ë¡¤ëŸ¬ ê²Œì„íŒ¨ë“œ ì‚¬ìš© ê°€ëŠ¥`, "#4caf50");
            } else {
              log(`âš ï¸ ${hand} ì»¨íŠ¸ë¡¤ëŸ¬ì— ê²Œì„íŒ¨ë“œ ì—†ìŒ`, "#ff9800");
            }
          }
        });
      }

      function startInputMonitoring() {
        if (isTracking) return;
        isTracking = true;

        function monitorLoop() {
          if (isTracking && session) {
            monitorInputs();
            requestAnimationFrame(monitorLoop);
          }
        }
        monitorLoop();
      }

      function monitorInputs() {
        if (!session) return;

        const inputSources = session.inputSources;

        inputSources.forEach((source) => {
          const hand = source.handedness;

          if ((hand === "left" || hand === "right") && source.gamepad) {
            checkGamepadInput(source.gamepad, hand);
          }
        });
      }

      function checkGamepadInput(gamepad, hand) {
        const buttons = gamepad.buttons;
        const axes = gamepad.axes;

        // ë²„íŠ¼ ìƒíƒœ í™•ì¸
        buttons.forEach((button, index) => {
          const buttonElement = document.getElementById(`${hand}-${index}`);

          if (button.pressed) {
            if (buttonElement) {
              buttonElement.classList.add("pressed");
            }

            const currentTime = Date.now();
            if (currentTime - lastInputTime > 500) {
              // 0.5ì´ˆë§ˆë‹¤ ë¡œê·¸
              log(
                `ğŸ¯ ${hand} ë²„íŠ¼ ${index} ëˆŒë¦¼ (ê°’: ${button.value.toFixed(
                  3
                )})`,
                "#4caf50"
              );
              lastInputTime = currentTime;
            }
          } else {
            if (buttonElement) {
              buttonElement.classList.remove("pressed");
            }
          }
        });

        // ì¡°ì´ìŠ¤í‹± í™•ì¸
        if (axes.length >= 2) {
          const x = axes[0];
          const y = axes[1];

          if (Math.abs(x) > 0.1 || Math.abs(y) > 0.1) {
            const currentTime = Date.now();
            if (currentTime - lastInputTime > 500) {
              log(
                `ğŸ•¹ï¸ ${hand} ì¡°ì´ìŠ¤í‹±: X=${x.toFixed(3)}, Y=${y.toFixed(3)}`,
                "#4caf50"
              );
              lastInputTime = currentTime;
            }
          }
        }
      }

      async function testPermissions() {
        log("ğŸ” ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œì‘...", "#2196f3");

        // ëª¨ì…˜ ì„¼ì„œ ê¶Œí•œ í…ŒìŠ¤íŠ¸
        try {
          if ("permissions" in navigator) {
            const permissions = await navigator.permissions.query({
              name: "accelerometer",
            });
            log(
              `ğŸ“± ê°€ì†ë„ê³„ ê¶Œí•œ: ${permissions.state}`,
              permissions.state === "granted" ? "#4caf50" : "#ff9800"
            );
          }
        } catch (e) {
          log(`âš ï¸ ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨: ${e.message}`, "#ff9800");
        }

        // ë””ë°”ì´ìŠ¤ ë°©í–¥ ì´ë²¤íŠ¸ í…ŒìŠ¤íŠ¸
        if ("DeviceOrientationEvent" in window) {
          log("âœ… DeviceOrientationEvent ì§€ì›ë¨", "#4caf50");
        } else {
          log("âŒ DeviceOrientationEvent ë¯¸ì§€ì›", "#f44336");
        }

        // WebXR ê¶Œí•œ í…ŒìŠ¤íŠ¸
        try {
          const xrPermission = await navigator.permissions.query({
            name: "xr-spatial-tracking",
          });
          log(
            `ğŸ¥½ XR ì¶”ì  ê¶Œí•œ: ${xrPermission.state}`,
            xrPermission.state === "granted" ? "#4caf50" : "#ff9800"
          );
        } catch (e) {
          log(`âš ï¸ XR ê¶Œí•œ í™•ì¸ ë¶ˆê°€: ${e.message}`, "#ff9800");
        }
      }

      async function testAlternativeMethod() {
        log("ğŸ”„ ëŒ€ì²´ ê°ì§€ ë°©ë²• í…ŒìŠ¤íŠ¸...", "#2196f3");

        try {
          // ë‹¤ë¥¸ ì„¸ì…˜ ì˜µì…˜ìœ¼ë¡œ ì¬ì‹œë„
          if (session) {
            await session.end();
          }

          session = await navigator.xr.requestSession("immersive-vr", {
            requiredFeatures: [],
            optionalFeatures: ["local-floor", "bounded-floor", "hand-tracking"],
          });

          log("âœ… ëŒ€ì²´ ë°©ë²•ìœ¼ë¡œ VR ì„¸ì…˜ ìƒì„± ì„±ê³µ", "#4caf50");

          // ê°•ì œë¡œ ì…ë ¥ ì†ŒìŠ¤ ìƒˆë¡œê³ ì¹¨
          setTimeout(() => {
            checkInputSources();
          }, 1000);

          startInputMonitoring();
        } catch (error) {
          log(`âŒ ëŒ€ì²´ ë°©ë²• ì‹¤íŒ¨: ${error.message}`, "#f44336");
        }
      }

      function updateControllerUI(hand, status, connected) {
        const infoElement = document.getElementById(`${hand}-info`);
        const cardElement = document.getElementById(`${hand}-controller`);

        infoElement.textContent = `ìƒíƒœ: ${status}`;
        cardElement.className = connected
          ? "controller-card active"
          : "controller-card";
      }

      function resetControllerUI() {
        ["left", "right"].forEach((hand) => {
          updateControllerUI(hand, "ì—°ê²° ëŒ€ê¸° ì¤‘", false);

          for (let i = 0; i < 6; i++) {
            const buttonElement = document.getElementById(`${hand}-${i}`);
            if (buttonElement) {
              buttonElement.classList.remove("pressed");
            }
          }
        });
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      window.onload = function () {
        log("ğŸ”§ Quest ì»¨íŠ¸ë¡¤ëŸ¬ ìˆ˜ì • ë„êµ¬ ì‹œì‘", "#4ecdc4");
        log('ğŸ’¡ ë¨¼ì € "ì „ì²´ ì§„ë‹¨ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”', "#2196f3");
      };
    </script>
  </body>
</html>
