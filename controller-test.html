<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ë‹¨ ë„êµ¬</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: white;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 30px;
        backdrop-filter: blur(10px);
      }

      h1 {
        text-align: center;
        color: #4ecdc4;
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
      }

      .success {
        background: #4caf50;
      }
      .error {
        background: #f44336;
      }
      .info {
        background: #2196f3;
      }

      button {
        background: #4ecdc4;
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        margin: 5px;
        font-size: 16px;
      }

      button:hover {
        background: #45b7b8;
      }

      button:disabled {
        background: #666;
        cursor: not-allowed;
      }

      #log {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 8px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        margin-top: 20px;
      }

      .controller-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 20px;
      }

      .controller-card {
        background: rgba(0, 0, 0, 0.3);
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #666;
      }

      .controller-card.connected {
        border-color: #4caf50;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ•¹ï¸ ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ë‹¨ ë„êµ¬</h1>

      <div id="status-display"></div>

      <button onclick="testController()">ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ì‹œì‘</button>
      <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>

      <div class="controller-info">
        <div id="left-controller" class="controller-card">
          <h3>ğŸ‘ˆ ì™¼ìª½ ì»¨íŠ¸ë¡¤ëŸ¬</h3>
          <div id="left-status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
        <div id="right-controller" class="controller-card">
          <h3>ğŸ‘‰ ì˜¤ë¥¸ìª½ ì»¨íŠ¸ë¡¤ëŸ¬</h3>
          <div id="right-status">ì—°ê²° ëŒ€ê¸° ì¤‘...</div>
        </div>
      </div>

      <div id="log"></div>
    </div>

    <script>
      let session = null;
      let isTracking = false;

      function log(message) {
        const logElement = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        logElement.textContent += `[${timestamp}] ${message}\n`;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(message);
      }

      function clearLog() {
        document.getElementById("log").textContent = "";
      }

      function updateStatus(message, type) {
        const statusDiv = document.getElementById("status-display");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      async function testController() {
        try {
          log("ğŸš€ ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ ì‹œì‘...");

          // WebXR ì§€ì› í™•ì¸
          if (!navigator.xr) {
            throw new Error("WebXRì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
          }

          // VR ì„¸ì…˜ ì§€ì› í™•ì¸
          const supported = await navigator.xr.isSessionSupported(
            "immersive-vr"
          );
          if (!supported) {
            throw new Error("VR ì„¸ì…˜ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }

          log("âœ… WebXR ì§€ì› í™•ì¸ ì™„ë£Œ");

          // VR ì„¸ì…˜ ìš”ì²­
          session = await navigator.xr.requestSession("immersive-vr");
          log("âœ… VR ì„¸ì…˜ ìƒì„± ì„±ê³µ!");
          updateStatus(
            "âœ… VR ì„¸ì…˜ í™œì„±í™” - ì»¨íŠ¸ë¡¤ëŸ¬ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”!",
            "success"
          );

          // ì…ë ¥ ì†ŒìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
          session.addEventListener("inputsourceschange", (event) => {
            log(
              `ì…ë ¥ ì†ŒìŠ¤ ë³€ê²½: +${event.added.length}, -${event.removed.length}`
            );
            checkControllers();
          });

          // ì„¸ì…˜ ì¢…ë£Œ ì´ë²¤íŠ¸
          session.addEventListener("end", () => {
            log("VR ì„¸ì…˜ ì¢…ë£Œë¨");
            updateStatus("âŒ VR ì„¸ì…˜ ì¢…ë£Œë¨", "error");
            isTracking = false;
            resetControllerStatus();
          });

          // ì»¨íŠ¸ë¡¤ëŸ¬ ì¶”ì  ì‹œì‘
          startControllerTracking();
        } catch (error) {
          log(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`);
          updateStatus(`âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨: ${error.message}`, "error");
        }
      }

      function startControllerTracking() {
        isTracking = true;

        function trackLoop() {
          if (isTracking && session) {
            checkControllers();
            requestAnimationFrame(trackLoop);
          }
        }
        trackLoop();
      }

      function checkControllers() {
        if (!session) return;

        const inputSources = session.inputSources;

        // ì»¨íŠ¸ë¡¤ëŸ¬ ìƒíƒœ ì´ˆê¸°í™”
        resetControllerStatus();

        log(`í˜„ì¬ ì…ë ¥ ì†ŒìŠ¤ ê°œìˆ˜: ${inputSources.length}`);

        for (let i = 0; i < inputSources.length; i++) {
          const source = inputSources[i];
          const hand = source.handedness;

          log(`ì…ë ¥ ì†ŒìŠ¤ ${i}: ì†=${hand}, íƒ€ì…=${source.targetRayMode}`);

          if (hand === "left") {
            updateControllerStatus("left", "âœ… ì—°ê²°ë¨", true);
            if (source.gamepad) {
              checkGamepadButtons(source.gamepad, "left");
            }
          } else if (hand === "right") {
            updateControllerStatus("right", "âœ… ì—°ê²°ë¨", true);
            if (source.gamepad) {
              checkGamepadButtons(source.gamepad, "right");
            }
          }
        }
      }

      function checkGamepadButtons(gamepad, hand) {
        const buttons = gamepad.buttons;
        const axes = gamepad.axes;

        // ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œë§Œ ë¡œê·¸
        buttons.forEach((button, index) => {
          if (button.pressed) {
            log(
              `${hand} ì»¨íŠ¸ë¡¤ëŸ¬ ë²„íŠ¼ ${index} ëˆŒë¦¼ (ê°’: ${button.value.toFixed(
                2
              )})`
            );
          }
        });

        // ì¡°ì´ìŠ¤í‹± ì›€ì§ì„ ê°ì§€
        if (axes.length >= 2) {
          const x = axes[0];
          const y = axes[1];
          if (Math.abs(x) > 0.2 || Math.abs(y) > 0.2) {
            log(`${hand} ì¡°ì´ìŠ¤í‹±: X=${x.toFixed(2)}, Y=${y.toFixed(2)}`);
          }
        }
      }

      function updateControllerStatus(hand, status, connected) {
        const statusElement = document.getElementById(`${hand}-status`);
        const cardElement = document.getElementById(`${hand}-controller`);

        statusElement.textContent = status;
        cardElement.className = connected
          ? "controller-card connected"
          : "controller-card";
      }

      function resetControllerStatus() {
        updateControllerStatus("left", "âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ", false);
        updateControllerStatus("right", "âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ", false);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
      window.onload = function () {
        log("ì»¨íŠ¸ë¡¤ëŸ¬ ì§„ë‹¨ ë„êµ¬ ì‹œì‘");

        if (navigator.xr) {
          navigator.xr.isSessionSupported("immersive-vr").then((supported) => {
            if (supported) {
              updateStatus(
                "âœ… WebXR VR ì§€ì›ë¨ - í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•˜ì„¸ìš”",
                "success"
              );
            } else {
              updateStatus("âŒ VR ì„¸ì…˜ ë¯¸ì§€ì›", "error");
            }
          });
        } else {
          updateStatus("âŒ WebXR ë¯¸ì§€ì›", "error");
        }
      };
    </script>
  </body>
</html>
